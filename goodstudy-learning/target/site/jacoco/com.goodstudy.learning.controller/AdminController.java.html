<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="zh"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>AdminController.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">goodstudy-learning</a> &gt; <a href="index.source.html" class="el_package">com.goodstudy.learning.controller</a> &gt; <span class="el_source">AdminController.java</span></div><h1>AdminController.java</h1><pre class="source lang-java linenums">package com.goodstudy.learning.controller;

import com.goodstudy.learning.dto.*;
import com.goodstudy.learning.service.*;
import org.springframework.http.*;
import org.springframework.web.bind.annotation.*;
import org.springframework.web.multipart.MultipartFile;
import java.util.*;
import java.io.*;
import java.nio.charset.StandardCharsets;

@RestController
@RequestMapping(&quot;/api/admin&quot;)
public class AdminController {

    private final LearningService learningService;
<span class="fc" id="L17">    private final CourseServicePlaceholder placeholder = new CourseServicePlaceholder();</span>

<span class="fc" id="L19">    public AdminController(LearningService learningService) {</span>
<span class="fc" id="L20">        this.learningService = learningService;</span>
<span class="fc" id="L21">    }</span>

    // Bulk CSV import of courses: simple parser that expects title,description,level,published
    @PostMapping(value = &quot;/courses/import&quot;, consumes = MediaType.MULTIPART_FORM_DATA_VALUE)
    public ResponseEntity&lt;Map&lt;String,Object&gt;&gt; importCourses(@RequestParam(&quot;file&quot;) MultipartFile file) {
<span class="nc" id="L26">        try (BufferedReader br = new BufferedReader(new InputStreamReader(file.getInputStream(), StandardCharsets.UTF_8))) {</span>
            String line;
<span class="nc" id="L28">            int count = 0;</span>
<span class="nc bnc" id="L29" title="All 2 branches missed.">            while ((line = br.readLine()) != null) {</span>
<span class="nc" id="L30">                String[] parts = line.split(&quot;,&quot;, -1);</span>
<span class="nc bnc" id="L31" title="All 2 branches missed.">                if (parts.length &gt;= 4) {</span>
<span class="nc" id="L32">                    CourseDto dto = CourseDto.builder()</span>
<span class="nc" id="L33">                            .title(parts[0])</span>
<span class="nc" id="L34">                            .description(parts[1])</span>
<span class="nc" id="L35">                            .level(parts[2])</span>
<span class="nc" id="L36">                            .published(Boolean.parseBoolean(parts[3]))</span>
<span class="nc" id="L37">                            .build();</span>
<span class="nc" id="L38">                    learningService.createCourse(dto);</span>
<span class="nc" id="L39">                    count++;</span>
                }
<span class="nc" id="L41">            }</span>
<span class="nc" id="L42">            Map&lt;String,Object&gt; r = new HashMap&lt;&gt;();</span>
<span class="nc" id="L43">            r.put(&quot;imported&quot;, count);</span>
<span class="nc" id="L44">            return ResponseEntity.ok(r);</span>
<span class="nc" id="L45">        } catch (IOException ex) {</span>
<span class="nc" id="L46">            throw new IllegalArgumentException(&quot;Failed to read file&quot;);</span>
        }
    }

    // simple CSV export of courses
    @GetMapping(value = &quot;/courses/export&quot;, produces = &quot;text/csv&quot;)
    public ResponseEntity&lt;String&gt; exportCourses() {
<span class="nc" id="L53">        var courses = learningService.listCourses(false);</span>
<span class="nc" id="L54">        StringBuilder sb = new StringBuilder();</span>
<span class="nc" id="L55">        sb.append(&quot;title,description,level,published\n&quot;);</span>
<span class="nc bnc" id="L56" title="All 2 branches missed.">        for (CourseDto c : courses) {</span>
<span class="nc" id="L57">            sb.append(escape(c.getTitle())).append(&quot;,&quot;).append(escape(c.getDescription())).append(&quot;,&quot;).append(escape(c.getLevel())).append(&quot;,&quot;).append(c.isPublished()).append(&quot;\n&quot;);</span>
<span class="nc" id="L58">        }</span>
<span class="nc" id="L59">        return ResponseEntity.ok().header(HttpHeaders.CONTENT_DISPOSITION, &quot;attachment; filename= courses.csv&quot;).body(sb.toString());</span>
    }

    private String escape(String s) {
<span class="nc bnc" id="L63" title="All 2 branches missed.">        if (s == null) return &quot;&quot;;</span>
<span class="nc" id="L64">        return s.replace(&quot;\n&quot;,&quot; &quot;).replace(&quot;,&quot;,&quot;;&quot;);</span>
    }

    // A placeholder class to show additional admin utilities (not a service)
<span class="fc" id="L68">    static class CourseServicePlaceholder {</span>
<span class="nc" id="L69">        public String ping() { return &quot;pong&quot;; }</span>
    }
}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.10.202304240956</span></div></body></html>